
CREATE TABLE Rol 
(Id int identity(1,1) Primary key ,
Nombre varchar(255),
Activo int default 1,
unique(Nombre)
)


insert into Rol (Nombre) values ('Administrador')

go

CREATE TABLE Usuario 
(Id int identity(1,1) Primary key ,
IdUser varchar(255),
Usuario varchar(255),
Password varchar(255),
Email varchar(255),
Nombre varchar(255),
IdRol int,
ImagenPerfil varchar(255),
FechaCreacion datetime,
FechaVigencia date,
Activo int default 1,
unique(Iduser),
unique(Usuario)
)

ALTER TABLE Usuario ADD CONSTRAINT FK_IdRol FOREIGN KEY (IdRol) references Rol(Id)

--SELECT CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  'Admin' ), 2) 
--SELECT CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  'Invitado' ), 2) 
--SELECT CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  'Admin2021*' ), 2) 
--SELECT CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  'Invitado2021' ), 2) 
--DBCC CHECKIDENT ('Usuario', RESEED, 0)
--delete from Usuario

go

insert into Usuario (IdUser,Usuario,Password,Email,Nombre,IdRol,FechaCreacion, FechaVigencia, ImagenPerfil)values('E3AFED0047B08059D0FADA10F400C1E5','Admin','E3778380B0360F5E35411C728FCFBD0B','gestionsystem@admin.com','Administrador GestionSystem',1, GETDATE(), '2022-12-30','\Sources\ImagesPerfilUsers\Usuario.png')

go

CREATE PROCEDURE [dbo].[SP_BuscarRolUsuario] @IdUser varchar(255), @Resultado varchar(255) OUTPUT
AS
BEGIN
	DECLARE		@Rol varchar(255)
		SELECT	@Rol = R.Nombre 
		FROM	Rol R,
				Usuario U
		WHERE	R.Id = U.IdRol
				and U.IdUser = @IdUser
	
	SET @Resultado = @Rol
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GridRol]
AS
BEGIN
	SELECT	Id, 
			Nombre, 
			Activo,
			CASE Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado
			FROM Rol
END

go

CREATE PROCEDURE [dbo].[SP_CrearRol] @IdUser varchar(255), @Modulo varchar(255), @NombreRol varchar(255), @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
	SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)	
	IF @Crear > 0
			BEGIN
				INSERT INTO Rol (Nombre) VALUES (@NombreRol) 
				SET @Resultado = 'OK__Se a creado el Rol (' + @NombreRol+ ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear el Rol' 
			END
	SELECT @Resultado
END
go

CREATE PROCEDURE [dbo].[SP_EliminarRol] @IdUser varchar(255), @Modulo varchar(255), @IdRol int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @validar INT, @NombreRol varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreRol = Nombre FROM Rol WHERE Id = @IdRol
SELECT	@Eliminar =  dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)
		IF @Eliminar > 0
			BEGIN	
				SELECT @validar = COUNT(1) FROM Usuario WHERE IdRol = @IdRol
				IF @validar > 0 
					BEGIN
						SET @Resultado = 'Error__El Rol (' + @NombreRol +') no se puede Eliminar, actualmente se encuentra siendo usado por otros Usuarios'	
					END
				ELSE
					BEGIN
						DELETE Rol WHERE Id = @IdRol
						SET @Resultado = 'OK__Se Elimino el Rol correctamente'	
					END								
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar el Rol' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE	[dbo].[SP_GuardarCambiosRol] @IdUser varchar(255), @Modulo varchar(255), @IdRol int, @NombreRol varchar(255), @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
	SELECT	@Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)
	IF @Modificar > 0
					BEGIN
						UPDATE Rol SET  Nombre = @NombreRol, Activo = @Activo WHERE Id = @IdRol
						SET @Resultado = 'OK__Se guardaron los cambios del Rol (' + @NombreRol+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios al Rol' 
					END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_ListaRol]
AS
BEGIN
	SELECT Id, Nombre FROM Rol WHERE Activo = 1
END

go

CREATE TABLE Log_InicioSesion
(Id int identity(1,1) Primary key ,
IdUser int,
FechaIngreso datetime
)

ALTER TABLE Log_InicioSesion ADD CONSTRAINT FK_IdUsuarioLog_InicioSesion FOREIGN KEY (IdUser) references Usuario(Id)

go

CREATE PROCEDURE SP_GridHistorialIngresoUsuario @IdUser varchar(255)
AS
BEGIN
DECLARE @IdUsuario INT
SELECT @IdUsuario = Id FROM Usuario Where IdUser = @IdUser
	SELECT	CONVERT(varchar,L.FechaIngreso,20) As FechaIngreso,
			U.Nombre As Usuario
	FROM	Log_InicioSesion L,
			Usuario U
	WHERE	L.IdUser = @IdUsuario
			and U.Id = L.IdUser
END

go

CREATE PROCEDURE [dbo].[SP_IniciarSesion] @Usuario varchar(255), @Password varchar(255), 
@Resultado varchar(max) OUTPUT
AS
BEGIN
DECLARE @ExisteUser INT, @ValidaPassword varchar(255), @IdUser varchar(255),
	@PasswordMd5 varchar(255), @UsuarioMd5 varchar(255), @IdUsuario int, @Vigencia datetime,
	@NombreUser varchar(255), @FechaActual datetime, @Activo Int
	SELECT @UsuarioMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Usuario ), 2)
	SELECT @PasswordMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Password ), 2)
	SELECT @ExisteUser = COUNT(1) FROM Usuario Where IdUser = @UsuarioMd5
	SELECT @ValidaPassword = Password  FROM Usuario WHERE IdUser = @UsuarioMd5
	SELECT @IdUsuario = Id FROM Usuario Where IdUser = @UsuarioMd5
	SELECT @NombreUser = Usuario FROM Usuario WHERE IdUser =  @UsuarioMd5
	SELECT @Vigencia = FechaVigencia FROM Usuario WHERE IdUser = @UsuarioMd5
	SELECT @FechaActual = GETDATE()
	Select @Activo = Activo FROM Usuario WHERE Id = @IdUsuario
	
	IF @ExisteUser = 0
		BEGIN
			SET @Resultado = 'Error__El Usuario ingresado no Existe'
		END
	ELSE
		BEGIN		
		SELECT @IdUser = IdUser FROM Usuario where IdUser = @UsuarioMd5
			IF @ValidaPassword = @PasswordMd5
				BEGIN
					IF @FechaActual < @Vigencia  
						BEGIN
							IF @Activo = 1
								BEGIN
									INSERT INTO Log_InicioSesion (IdUser,FechaIngreso)VALUES(@IdUsuario, GETDATE())
									SET @Resultado = 'OK__'+@IdUser
								END
							ELSE
								BEGIN
									SET @Resultado = 'Error__El Usuario se encuentra Inactivo, por favor comuniquese con el Administrador de la Aplicación'
								END
						END
					ELSE
						BEGIN
							SET @Resultado = 'Error__El Usuario '+@NombreUser+' no tiene permisos para ingresar a la Aplicación, la fecha limite de ingreso se encuentra vencida. Si desea Activar un nuevo periodo de tiempo comuniquese con el Administrador de la Aplicación.'
						END					
				END
			ELSE
				BEGIN
					SET @Resultado = 'Error__Contraseña incorrecta'
				END
		END
	SELECT @Resultado
END

go

CREATE TABLE Modulo 
(Id int identity(1,1) Primary key ,
Nombre varchar(255),
RutaPagina varchar(255),
Activo int default 1,
IdUsuarioCrea int,
FechaCreacion datetime,
unique(Nombre),
unique(Rutapagina)
)


ALTER TABLE Modulo ADD CONSTRAINT FK_IdUsuarioCreaModulo FOREIGN KEY (IdUsuarioCrea ) references Usuario(Id)

Insert into Modulo (Nombre, RutaPagina) values ('Usuario','/UsersManagement/Users')
Insert into Modulo (Nombre, RutaPagina) values ('Permiso Usuario','/UsersManagement/PermisoUsers')
Insert into Modulo (Nombre, RutaPagina) values ('Rol Usuario','/UsersManagement/RolUsers')
Insert into Modulo (Nombre, RutaPagina) values ('Información Usuario','/Usuario/InformacionUsuario')
Insert into Modulo (Nombre, RutaPagina) values ('Modulo','/Modulo/Modulo')

go

CREATE PROCEDURE [dbo].[SP_GridModulo]
AS
BEGIN
	SELECT	Id, 
			Nombre,
			RutaPagina,
			Activo,
			CASE Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado,
			dbo.Fun_BuscarNombreUsuario(IdUsuarioCrea) As NombreUsuario, 
			CONVERT(varchar,FechaCreacion,20) AS FechaCreacion
			FROM Modulo
END

go

CREATE PROCEDURE [dbo].[SP_ListaModulo]
AS
BEGIN
	SELECT Id, Nombre FROM Modulo WHERE Activo = 1
END

go

CREATE PROCEDURE [dbo].[SP_CrearModulo] @IdUser varchar(255), @Modulo varchar(255), @NombreModulo varchar(255), @UrlPagina varchar(255),@Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
	SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)
	IF @Crear > 0
			BEGIN
				INSERT INTO Modulo(Nombre,RutaPagina,IdUsuarioCrea, FechaCreacion) VALUES (@NombreModulo,@UrlPagina,@IdUsuario, GETDATE()) 
				SET @Resultado = 'OK__Se a creado el Modulo (' + @NombreModulo + ') y la Url (' + @UrlPagina + ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear Permisos'
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE	[dbo].[SP_GuardarCambiosModulo] @IdUser varchar(255), @Modulo varchar(255), @IdModulo int, @NombreModulo varchar(255), @UrlPagina varchar(255), @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
	SELECT @Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)	
				IF @Modificar > 0
					BEGIN
						UPDATE Modulo 
						SET	Nombre = @NombreModulo, 
							RutaPagina = @UrlPagina,								
							Activo = @Activo 
						WHERE Id = @IdModulo								
						SET @Resultado = 'OK__Se guardaron los cambios del Modulo (' + @NombreModulo+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios al Modulo' 
					END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_EliminarModulo] @IdUser varchar(255), @Modulo varchar(255), @IdModulo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @validar INT, @NombreModulo varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreModulo = Nombre FROM Modulo WHERE Id = @IdModulo
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)
		IF @Eliminar > 0
			BEGIN	
				SELECT @validar = COUNT(1) FROM PermisoUsuario WHERE IdModulo = @IdModulo
				IF @validar > 0 
					BEGIN
						SET @Resultado = 'Error__El modulo (' + @NombreModulo +') no se puede Eliminar, actualmente se encuentra siendo usado por otros Usuarios'	
					END
				ELSE
					BEGIN
						DELETE Modulo WHERE ID = @IdModulo
						SET @Resultado = 'OK__Se Elimino el Modulo correctamente'	
					END								
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar el Modulo' 
			END
	SELECT @Resultado
END

go

CREATE TABLE PermisoUsuario 
(Id int identity(1,1) Primary key ,
IdUsuario int,
IdModulo int,
Leer int,
Crear int,
Modificar int,
Eliminar int,
IdUsuarioCrea int,
FechaCreacion datetime
)

ALTER TABLE PermisoUsuario ADD CONSTRAINT FK_IdUsuarioPermisoModulo FOREIGN KEY (IdUsuario) references Usuario(Id)
ALTER TABLE PermisoUsuario ADD CONSTRAINT FK_IdUsuarioCreaPermiso FOREIGN KEY (IdUsuarioCrea ) references Usuario(Id)
ALTER TABLE PermisoUsuario ADD CONSTRAINT FK_IdModuloPermiso FOREIGN KEY (IdModulo ) references Modulo(Id)

insert into PermisoUsuario (IdUsuario,IdModulo,Leer,Crear,Modificar,Eliminar,IdUsuarioCrea,FechaCreacion) Values (1,1,1,1,1,1,1,GETDATE())
insert into PermisoUsuario (IdUsuario,IdModulo,Leer,Crear,Modificar,Eliminar,IdUsuarioCrea,FechaCreacion) Values (1,2,1,1,1,1,1,GETDATE())
insert into PermisoUsuario (IdUsuario,IdModulo,Leer,Crear,Modificar,Eliminar,IdUsuarioCrea,FechaCreacion) Values (1,3,1,1,1,1,1,GETDATE())
insert into PermisoUsuario (IdUsuario,IdModulo,Leer,Crear,Modificar,Eliminar,IdUsuarioCrea,FechaCreacion) Values (1,4,1,1,1,1,1,GETDATE())
insert into PermisoUsuario (IdUsuario,IdModulo,Leer,Crear,Modificar,Eliminar,IdUsuarioCrea,FechaCreacion) Values (1,5,1,1,1,1,1,GETDATE())

go

CREATE FUNCTION Fun_PermisoUsuario(@Accion varchar(255), @IdUsuario Int, @Modulo varchar(255))
RETURNS int
AS
BEGIN	
	DECLARE @Resultado Int
	
	IF @Accion ='Leer'
		BEGIN			
			SELECT	@Resultado = P.Leer
			FROM	Usuario U,
					PermisoUsuario P,
					Modulo M
			WHERE	P.IdUsuario = U.Id and 
					U.Id = @IdUsuario and
					M.Id = P.IdModulo and
					M.RutaPagina = @Modulo
		END
	ELSE IF @Accion ='Crear'
		BEGIN			
			SELECT	@Resultado = P.Crear
			FROM	Usuario U,
					PermisoUsuario P,
					Modulo M
			WHERE	P.IdUsuario = U.Id and 
					U.Id = @IdUsuario and
					M.Id = P.IdModulo and
					M.RutaPagina = @Modulo
		END
	ELSE IF @Accion ='Modificar'
		BEGIN			
			SELECT	@Resultado = P.Modificar
			FROM	Usuario U,
					PermisoUsuario P,
					Modulo M
			WHERE	P.IdUsuario = U.Id and 
					U.Id = @IdUsuario and
					M.Id = P.IdModulo and
					M.RutaPagina = @Modulo
		END
	ELSE IF @Accion ='Eliminar'
		BEGIN			
			SELECT	@Resultado = P.Eliminar
			FROM	Usuario U,
					PermisoUsuario P,
					Modulo M
			WHERE	P.IdUsuario = U.Id and 
					U.Id = @IdUsuario and
					M.Id = P.IdModulo and
					M.RutaPagina = @Modulo
		END
	RETURN @Resultado
END
GO


go

CREATE PROCEDURE [dbo].[SP_CrearPermisoUsuario] @IdUser varchar(255), @Modulo varchar(255), @IdUsuarioPermiso int,@IdModuloPermiso int,@Leer int,@CrearNuevo int,@Modificar int,@Eliminar int,@Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @ValidarPermiso INT, @NombreUsuarioPermiso varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuarioPermiso = Nombre FROM Usuario WHERE Id = @IdUsuarioPermiso
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
	SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)
		IF @Crear > 0
			BEGIN	
				SELECT @ValidarPermiso = COUNT(1) FROM PermisoUsuario WHERE IdUsuario = @IdUsuarioPermiso and IdModulo = @IdModuloPermiso
				
				IF @ValidarPermiso > 0
					BEGIN
						SET @Resultado = 'Error__El Permiso que esta creando ya Existe para el Usuario (' + @NombreUsuarioPermiso + '), por favor valide'
					END
				ELSE
					BEGIN
						INSERT INTO PermisoUsuario(IdUsuario,IdModulo,Leer,Crear,Modificar,Eliminar,IdUsuarioCrea, FechaCreacion) 
						VALUES 
						(@IdUsuarioPermiso,@IdModuloPermiso,@Leer,@CrearNuevo,@Modificar,@Eliminar,@IdUsuario, GETDATE()) 
						SET @Resultado = 'OK__Se a creado el permiso para el Usuario (' + @NombreUsuarioPermiso + ') correctamente'
					END
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear Permisos' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GuardarCambiosPermisoUsuario] @IdUser varchar(255), @Modulo varchar(255), @IdPermisoUsuario int,@Leer int,@CrearNuevo int,@Modificar int,@Eliminar int,@Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modifica INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @NombreUsuarioPermiso varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuarioPermiso = U.Nombre FROM Usuario U, PermisoUsuario P WHERE U.Id = P.IdUsuario and P.Id = @IdPermisoUsuario
SELECT	@Modifica = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)
		IF @Modifica > 0
			BEGIN	
				UPDATE PermisoUsuario SET	Leer = @Leer,
											Crear = @CrearNuevo,
											Modificar = @Modificar,
											Eliminar = @Eliminar
				WHERE Id = @IdPermisoUsuario
				SET @Resultado = 'OK__Se modificaron los Permisos para el Usuario (' + @NombreUsuarioPermiso + ') correctamente'					
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Modificar los Permisos' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_EliminarPermisoUsuario] @IdUser varchar(255), @Modulo varchar(255), @IdPermisoUsuario int,@Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)
		IF @Eliminar > 0
			BEGIN	
				DELETE PermisoUsuario WHERE ID = @IdPermisoUsuario
				SET @Resultado = 'OK__Se Elimino el permiso correctamente'					
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario '+ @NombreUsuario + ' no tiene permiso para Eliminar el Permiso' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_ValidarIngresoPagina] @IdUser varchar(255), @Modulo varchar(255), @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @IdUsuario INT, @Leer INT, @ValidarUsuario INT, @NombreUsuario varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @ValidarUsuario = COUNT(1) FROM PermisoUsuario WHERE IdUsuario = @IdUsuario
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
IF @ValidarUsuario = 0
	BEGIN
		SET @Resultado = 'El Usuario ('+ @NombreUsuario + ') no tiene permiso para ingresar a este Modulo' 
	END
ELSE 
	BEGIN
		SELECT	@Leer = dbo.Fun_PermisoUsuario('Leer',@IdUsuario, @Modulo)
		IF @LEER > 0
			BEGIN	
				SET @Resultado = 'OK'
			END
		ELSE
			BEGIN
				SET @Resultado = 'El Usuario ('+ @NombreUsuario + ') no tiene permiso para ingresar a este Modulo' 
			END
	END
	SELECT @Resultado
END

go

CREATE FUNCTION [dbo].[Fun_BuscarNombreUsuario] (@idUsuario INT)
RETURNS VARCHAR(255)
AS BEGIN
DECLARE @NombreUsuario VARCHAR(255)
	SELECT	@NombreUsuario = Nombre
	FROM	Usuario
	WHERE	Id = @idUsuario 
	RETURN @NombreUsuario
END

go

CREATE PROCEDURE [dbo].[SP_ListaUsuario]
AS
BEGIN
	SELECT Id, Nombre FROM Usuario WHERE Activo = 1
END

go

CREATE PROCEDURE [dbo].[SP_GridUsuario]
AS
BEGIN
	SELECT	U.Id,
			U.Usuario,
			U.Email,
			U.Nombre As NombreUsuario,
			U.IdRol,
			R.Nombre As NombreRol,
			U.ImagenPerfil,
			CONVERT(varchar,U.FechaCreacion,20) AS FechaCreacion,			
			CAST(DATEPART(YEAR ,U.FechaVigencia) As Varchar)+'-'+CAST(DATEPART(MONTH ,U.FechaVigencia) As Varchar)+'-'+CAST(DATEPART(DAY ,U.FechaVigencia) As Varchar) AS FechaVigencia,			
			U.Activo,
			CASE U.Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado
			FROM	Usuario U,
					Rol R
			WHERE	U.IdRol = R.Id
END

go

CREATE PROCEDURE [dbo].[SP_CrearUsuario] @IdUser varchar(255), @Modulo varchar(255), @Usuario varchar(255), @PasswordUser varchar(255), @EmailUser varchar(255), @NombreUsuario varchar(255), @IdRol int, @FechaVigenciaUser datetime, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuarioCrea VARCHAR(255), @PasswordMd5 varchar(255), @UsuarioMd5 varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuarioCrea = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @UsuarioMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Usuario ), 2) 
SELECT @PasswordMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @PasswordUser ), 2)
	SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)
	IF @Crear > 0
			BEGIN
				INSERT INTO Usuario (IdUser, Usuario, Password, Email, Nombre, IdRol, ImagenPerfil, FechaCreacion, FechaVigencia) VALUES 
				(@UsuarioMd5, @Usuario, @PasswordMd5, @EmailUser, @NombreUsuario, @IdRol, '\Sources\ImagesPerfilUsers\Usuario.png', GETDATE(), @FechaVigenciaUser) 
				SET @Resultado = 'OK__Se a creado el Usuario (' + @Usuario+ ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuarioCrea + ') no tiene permiso para crear Usuario' 
			END
	SELECT @Resultado		
END

go


CREATE PROCEDURE [dbo].[SP_GuardarCambiosUsuario] @IdUser varchar(255), @Modulo varchar(255), @IdUsuario int, @Usuario varchar(255), @PasswordUser varchar(255), @EmailUser varchar(255), @NombreUsuario varchar(255), @IdRol int, @FechaVigenciaUser datetime, @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuarioCrea INT, @NombreUsuarioCrea VARCHAR(255), @ValidarIdUsuario INT, @ExisteUsuario INT, @PasswordMd5 varchar(255), @UsuarioMd5 varchar(255)
SELECT @IdUsuarioCrea = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuarioCrea = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @UsuarioMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Usuario ), 2) 
IF @PasswordUser = ''
	BEGIN
		SELECT @PasswordMd5 = Password FROM Usuario WHERE Id = @IdUsuario
	END
ELSE
	BEGIN
		SELECT @PasswordMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @PasswordUser ), 2)
	END

	SELECT @Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuarioCrea, @Modulo)	
				IF @Modificar > 0
					BEGIN
						UPDATE Usuario SET  IdUser = @UsuarioMd5,
											Usuario = @Usuario,
											Password = @PasswordMd5,
											Email = @EmailUser,
											Nombre = @NombreUsuario,
											IdRol = @IdRol,
											FechaVigencia = @FechaVigenciaUser,
											Activo = @Activo
										WHERE Id = @IdUsuario
						SET @Resultado = 'OK__Se guardaron los cambios del Usuario (' + @NombreUsuario+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuarioCrea + ') no tiene permiso para realizar cambios al País'
					END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_EliminarUsuario] @IdUser varchar(255), @Modulo varchar(255), @IdUsuario int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuarioCrea INT, @NombreUsuario VARCHAR(255), @ValidarUsuario int, @NombreUser varchar(255)
SELECT @IdUsuarioCrea = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @ValidarUsuario = COUNT(1) FROM PermisoUsuario WHERE IdUsuario = @IdUsuario
SELECT @NombreUser = Nombre FROM Usuario WHERE Id = @IdUsuario
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuarioCrea, @Modulo)
		IF @Eliminar > 0
			BEGIN	
				IF @ValidarUsuario > 0
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUser + ') no se puede Eliminar'
					END
				ELSE
					BEGIN
						DELETE Usuario WHERE ID = @IdUsuario
						SET @Resultado = 'OK__Se Elimino el Usuario correctamente'
					END									
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar el Usuario' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE SP_DatosUsuario @IdUser varchar(255)
AS
BEGIN
	SELECT	U.ImagenPerfil As RutaImagenUsuario,
			U.Usuario As Usuario,
			R.Nombre As RolUsuario,
			U.Nombre As NombreUsuario,
			U.Email As EmailUsuario,
			CONVERT(varchar,U.FechaCreacion,20) As FechaCreacion,
			CONVERT(varchar,U.FechaVigencia,20) As Vigencia			
	FROM	Usuario U,
			Rol R
	WHERE	U.IdUser = 	@IdUser
			AND U.IdRol = R.ID
END

go


CREATE PROCEDURE SP_CambiarPaswwordUsuario @IdUser varchar(255), @Modulo varchar(255), @Password varchar(255), @NuevoPassword varchar(255), @Resultado varchar(255) OUTPUT
AS
BEGIN
	DECLARE	@PasswordActual varchar(255), @PasswordMd5 varchar(255), @NuevoPasswordMd5 varchar(255),
	@Modificar Int, @NombreUsuario varchar(255), @IdUsuario Int

	SELECT @PasswordActual = Password FROM Usuario WHERE IdUser = @IdUser
	SELECT @PasswordMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Password ), 2)
	SELECT @NuevoPasswordMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @NuevoPassword ), 2)

	SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
	SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
	SELECT	@Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)	
	IF @Modificar > 0
			BEGIN
				IF @PasswordActual = @PasswordMd5
					BEGIN
						UPDATE Usuario SET Password = @NuevoPasswordMd5 WHERE IdUser = @IdUser
						SET @Resultado = 'OK__La contraseña se actualizo correctamente' 
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__La contraseña anterior ingresada es incorrecta'
					END
			END	
		ELSE 
			BEGIN	
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios a la Contraseña' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GridPermisoUsuario]
AS
BEGIN
	SELECT	PU.Id, 
			M.Nombre As Modulo, 
			U.Nombre As Usuario,
			Leer As IdLeer,
			CASE Leer
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as EstadoLeer,
			Crear As IdCrear,
			CASE Crear
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as EstadoCrear,
			Modificar As IdEditar,
			CASE Modificar
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as EstadoEditar,
			Eliminar As IdEliminar,
			CASE Eliminar
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as EstadoEliminar,
			dbo.Fun_BuscarNombreUsuario(PU.IdUsuarioCrea) As NombreUsuario, 
			CONVERT(varchar,PU.FechaCreacion,20) AS FechaCreacion
			FROM	PermisoUsuario PU,
					Usuario U,
					Modulo M
			WHERE	PU.IdUsuario = U.Id
					and M.Id = PU.IdModulo
END

go

CREATE TABLE Pais 
(Id int identity(1,1) Primary key ,
Nombre varchar(255),
Activo int default 1,
IdUsuarioCrea int,
FechaCreacion datetime,
unique(Nombre)
)

ALTER TABLE Pais ADD CONSTRAINT FK_IdUsuarioCreaPais FOREIGN KEY (IdUsuarioCrea ) references Usuario(Id)

go

CREATE PROCEDURE [dbo].[SP_CrearPais] @IdUser varchar(255), @Modulo varchar(255), @NombrePais varchar(255), @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)	
		IF @Crear > 0
			BEGIN
				INSERT INTO Pais (Nombre,IdUsuarioCrea, FechaCreacion) VALUES (@NombrePais, @IdUsuario, GETDATE()) 
				SET @Resultado = 'OK__Se a creado el País (' + @NombrePais+ ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear País' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GridPais]
AS
BEGIN
	SELECT	Id, 
			Nombre, 
			Activo,
			CASE Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado,
			dbo.Fun_BuscarNombreUsuario(IdUsuarioCrea) As NombreUsuario, 
			CONVERT(varchar,FechaCreacion,20) AS FechaCreacion
			FROM Pais
END

go

CREATE PROCEDURE [dbo].[SP_GuardarCambiosPais] @IdPais int, @IdUser varchar(255), @Modulo varchar(255), @NombrePais varchar(255), @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)	
				IF @Modificar > 0
					BEGIN
						UPDATE Pais SET  Nombre = @NombrePais, Activo = @Activo WHERE Id = @IdPais
					    SET @Resultado = 'OK__Se guardaron los cambios del País (' + @NombrePais+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios al País' 
					END
	SELECT @Resultado
END
go

CREATE PROCEDURE [dbo].[SP_ListaPais]
AS
BEGIN
	SELECT Id, Nombre FROM Pais WHERE Activo = 1
END

go

CREATE FUNCTION Fun_BuscarNombrePais (@idPais INT)
RETURNS VARCHAR(255)
AS BEGIN
DECLARE @NombrePais VARCHAR(255)
	SELECT	@NombrePais = Nombre
	FROM	Pais
	WHERE	Id = @idPais 
	RETURN @NombrePais
END

go


CREATE PROCEDURE [dbo].[SP_EliminarPais] @IdUser varchar(255), @Modulo varchar(255), @IdPais int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @validar INT, @NombrePais varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombrePais = Nombre FROM Pais WHERE Id = @IdPais
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)	
		IF @Eliminar > 0
			BEGIN	
				SELECT @validar = COUNT(1) FROM Departamento WHERE IdPais = @IdPais
				IF @validar > 0 
					BEGIN
						SET @Resultado = 'Error__El País (' + @NombrePais +') no se puede Eliminar, actualmente se encuentra en Uso'	
					END
				ELSE
					BEGIN
						DELETE Pais WHERE Id = @IdPais
						SET @Resultado = 'OK__Se Elimino el País correctamente'	
					END								
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar el País' 
			END
	SELECT @Resultado
END

go

CREATE TABLE Ciudad 
(Id int identity(1,1) Primary key ,
IdPais int,
Nombre varchar(255),
Activo int default 1,
IdUsuarioCrea int,
FechaCreacion datetime,
unique(Nombre)
)

ALTER TABLE Ciudad ADD CONSTRAINT FK_IdPais FOREIGN KEY (IdPais) references Pais(Id)
ALTER TABLE Ciudad ADD CONSTRAINT FK_IdUsuarioCreaDepartamento FOREIGN KEY (IdUsuarioCrea ) references Usuario(Id)

go

CREATE PROCEDURE [dbo].[SP_GridCiudad]
AS
BEGIN
	SELECT	C.Id, 
			P.Id As IdPais,
			P.Nombre As NombrePais, 
			C.Nombre,
			C.Activo,
			CASE C.Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado,
			dbo.Fun_BuscarNombreUsuario(C.IdUsuarioCrea) As NombreUsuario, 
			CONVERT(varchar,C.FechaCreacion,20) AS FechaCreacion
			FROM	Pais P,
					Ciudad C
			WHERE C.Idpais = P.Id
END

go

CREATE PROCEDURE [dbo].[SP_ListaCiudad]
AS
BEGIN
	SELECT Id, Nombre FROM Ciudad WHERE Activo = 1
END

go

CREATE PROCEDURE [dbo].[SP_CrearCiudad] @IdUser varchar(255), @Modulo varchar(255), @IdPais int, @NombreCiudad varchar(255), @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)	
		IF @Crear > 0
			BEGIN
				INSERT INTO Ciudad(IdPais,Nombre,IdUsuarioCrea, FechaCreacion) VALUES (@IdPais, @NombreCiudad, @IdUsuario, GETDATE()) 
				SET @Resultado = 'OK__Se a creado la Ciudad (' + @NombreCiudad+ ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear Ciudad' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GuardarCambiosCiudad] @IdUser varchar(255), @Modulo varchar(255), @IdPais int, @IdCiudad int, @NombreCiudad varchar(255), @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)	
				IF @Modificar > 0
					BEGIN
						UPDATE Ciudad SET  IdPais = @IdPais, Nombre = @NombreCiudad, Activo = @Activo WHERE Id = @IdCiudad
					    SET @Resultado = 'OK__Se guardaron los cambios de la Ciudad (' + @NombreCiudad+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios a la Ciudad' 
					END
	SELECT @Resultado
END
go

CREATE PROCEDURE [dbo].[SP_EliminarCiudad] @IdUser varchar(255), @Modulo varchar(255), @IdCiudad int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @validar INT, @NombreCiudad varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreCiudad = Nombre FROM Pais WHERE Id = @IdCiudad
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)	
		IF @Eliminar > 0
			BEGIN
			SET @validar = 0
				--SELECT @validar = COUNT(1) FROM Ciudad WHERE IdPais = @IdPais
				IF @validar > 0 
					BEGIN
						SET @Resultado = 'Error__La Ciudad (' + @NombreCiudad +') no se puede Eliminar, actualmente se encuentra en Uso'	
					END
				ELSE
					BEGIN
						DELETE Ciudad WHERE Id = @IdCiudad
						SET @Resultado = 'OK__Se Elimino la Ciudad correctamente'	
					END								
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar la Ciudad' 
			END
	SELECT @Resultado
END

go

CREATE TABLE TipoDocumento 
(Id int identity(1,1) Primary key ,
Nombre varchar(255),
Descripcion Varchar(255),
Activo int default 1,
IdUsuarioCrea int,
FechaCreacion datetime,
unique(Nombre)
)

ALTER TABLE TipoDocumento ADD CONSTRAINT FK_IdUsuarioCreaTipoDocumento FOREIGN KEY (IdUsuarioCrea ) references Usuario(Id)

go

CREATE PROCEDURE [dbo].[SP_CrearTipoDocumento] @IdUser varchar(255), @Modulo varchar(255), @NombreTipoDocumento varchar(255), @Descripcion varchar(255), @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)	
		IF @Crear > 0
			BEGIN
				INSERT INTO TipoDocumento (Nombre, Descripcion,IdUsuarioCrea, FechaCreacion) VALUES (@NombreTipoDocumento, @Descripcion, @IdUsuario, GETDATE()) 
				SET @Resultado = 'OK__Se a creado el Tipo Documento (' + @NombreTipoDocumento+ ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear el Tipo Documento' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GridTipoDocumento]
AS
BEGIN
	SELECT	Id, 
			Nombre, 
			Descripcion,
			Activo,
			CASE Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado,
			dbo.Fun_BuscarNombreUsuario(IdUsuarioCrea) As NombreUsuario, 
			CONVERT(varchar,FechaCreacion,20) AS FechaCreacion
			FROM TipoDocumento
END

go

CREATE PROCEDURE [dbo].[SP_GuardarCambiosTipoDocumento] @IdTipoDocumento int, @IdUser varchar(255), @Modulo varchar(255), @NombreTipoDocumento varchar(255), @Descripcion varchar(255), @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)	
				IF @Modificar > 0
					BEGIN
						UPDATE TipoDocumento SET  Nombre = @NombreTipoDocumento, Descripcion = @Descripcion ,Activo = @Activo WHERE Id = @IdTipoDocumento
					    SET @Resultado = 'OK__Se guardaron los cambios del TipoDocumento (' + @NombreTipoDocumento+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios al Tipo Documento' 
					END
	SELECT @Resultado
END
go

CREATE PROCEDURE [dbo].[SP_ListaTipoDocumento]
AS
BEGIN
	SELECT Id, Nombre FROM TipoDocumento WHERE Activo = 1
END

go

CREATE FUNCTION Fun_BuscarNombreTipoDocumento (@idTipoDocumento INT)
RETURNS VARCHAR(255)
AS BEGIN
DECLARE @NombreTipoDocumento VARCHAR(255)
	SELECT	@NombreTipoDocumento = Nombre
	FROM	TipoDocumento
	WHERE	Id = @idTipoDocumento 
	RETURN @NombreTipoDocumento
END

go


CREATE PROCEDURE [dbo].[SP_EliminarTipoDocumento] @IdUser varchar(255), @Modulo varchar(255), @IdTipoDocumento int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @validar INT, @NombreTipoDocumento varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreTipoDocumento = Nombre FROM TipoDocumento WHERE Id = @IdTipoDocumento
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)	
		IF @Eliminar > 0
			BEGIN	
			SET @validar = 0
				--SELECT @validar = COUNT(1) FROM Sucursal WHERE IdTipoDocumento = @IdTipoDocumento
				IF @validar > 0 
					BEGIN
						SET @Resultado = 'Error__El Tipo Documento (' + @NombreTipoDocumento +') no se puede Eliminar, actualmente se encuentra en Uso'	
					END
				ELSE
					BEGIN
						DELETE TipoDocumento WHERE Id = @IdTipoDocumento
						SET @Resultado = 'OK__Se Elimino el Tipo Documento correctamente'	
					END								
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar el Tipo Documento' 
			END
	SELECT @Resultado
END

go

CREATE TABLE Empresa 
(Id int identity(1,1) Primary key ,
Nombre varchar(255),
IdTipoDocumento int,
Identificacion varchar(255),
Email varchar(255),
Telefono varchar(255),
Contacto varchar(255),
Direccion varchar(255),
IdCiudad int,
Activo int default 1,
IdUsuarioCrea int,
FechaCreacion datetime,
unique(Nombre)
)

ALTER TABLE Empresa ADD CONSTRAINT FK_IdUsuarioCreaEmpresa FOREIGN KEY (IdUsuarioCrea ) references Usuario(Id)
ALTER TABLE Empresa ADD CONSTRAINT FK_IdTipoDocumentoCreaEmpresa FOREIGN KEY (IdTipoDocumento ) references TipoDocumento(Id)
ALTER TABLE Empresa ADD CONSTRAINT FK_IdCiudadCreaEmpresa FOREIGN KEY (IdCiudad ) references Ciudad(Id)

go

CREATE PROCEDURE [dbo].[SP_CrearEmpresa] @IdUser varchar(255), @Modulo varchar(255), @NombreEmpresa varchar(255), @IdTipoDocumento int, @IdentificacionEmpresa varchar(255), @EmailEmpresa varchar(255), @TelefonoEmpresa varchar(255), @ContactoEmpresa varchar(255), @DireccionEmpresa varchar(255), @IdCiudad int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)	
		IF @Crear > 0
			BEGIN
				INSERT INTO Empresa (Nombre,IdTipoDocumento,Identificacion,Email,Telefono,Contacto,Direccion,IdCiudad,IdUsuarioCrea, FechaCreacion) 
				VALUES 
				(@NombreEmpresa, @IdTipoDocumento, @IdentificacionEmpresa, @EmailEmpresa, @TelefonoEmpresa, @ContactoEmpresa, @DireccionEmpresa, @IdCiudad, @IdUsuario, GETDATE()) 
				SET @Resultado = 'OK__Se a creado la Empresa (' + @NombreEmpresa+ ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear País' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GridEmpresa]
AS
BEGIN
	SELECT	E.Id, 
			E.Nombre, 
			E.IdTipoDocumento,
			T.Nombre As TipoDocumento,
			E.Identificacion As IdentificacionEmpresa,
			E.Email,
			E.Telefono,
			E.Contacto, 
			E.Direccion As DireccionEmpresa,
			E.IdCiudad,
			C.Nombre As NombreCiudad,
			E.Activo,
			CASE E.Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado,
			dbo.Fun_BuscarNombreUsuario(E.IdUsuarioCrea) As NombreUsuario, 
			CONVERT(varchar,E.FechaCreacion,20) AS FechaCreacion
			FROM	Empresa E,
					TipoDocumento T,
					Ciudad C
			WHERE	E.IdCiudad = C.Id AND
					E.IdTipoDocumento = T.Id
END

go

CREATE PROCEDURE [dbo].[SP_GuardarCambiosEmpresa]  @IdUser varchar(255), @Modulo varchar(255), @IdEmpresa int, @NombreEmpresa varchar(255),@IdTipoDocumento int, @IdentificacionEmpresa varchar(255), @EmailEmpresa varchar(255), @TelefonoEmpresa varchar(255), @ContactoEmpresa varchar(255), @DireccionEmpresa varchar(255), @IdCiudad int, @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)	
				IF @Modificar > 0
					BEGIN
						UPDATE Empresa SET  Nombre = @NombreEmpresa, 
											IdTipoDocumento = @IdTipoDocumento,
											Identificacion = @IdentificacionEmpresa,
											Email = @EmailEmpresa,
											Telefono = @TelefonoEmpresa,
											Contacto = @ContactoEmpresa,
											Direccion = @DireccionEmpresa,
											IdCiudad = @IdCiudad,
											Activo = @Activo 
						WHERE Id = @IdEmpresa
					    SET @Resultado = 'OK__Se guardaron los cambios de la Empresa (' + @NombreEmpresa+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios al País' 
					END
	SELECT @Resultado
END
go

CREATE PROCEDURE [dbo].[SP_ListaEmpresa]
AS
BEGIN
	SELECT Id, Nombre FROM Empresa WHERE Activo = 1
END

go

CREATE FUNCTION Fun_BuscarNombreEmpresa (@idEmpresa INT)
RETURNS VARCHAR(255)
AS BEGIN
DECLARE @NombreEmpresa VARCHAR(255)
	SELECT	@NombreEmpresa = Nombre
	FROM	Empresa
	WHERE	Id = @idEmpresa 
	RETURN @NombreEmpresa
END

go


CREATE PROCEDURE [dbo].[SP_EliminarEmpresa] @IdUser varchar(255), @Modulo varchar(255), @IdEmpresa int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @validar INT, @NombreEmpresa varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreEmpresa = Nombre FROM Empresa WHERE Id = @IdEmpresa
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)	
		IF @Eliminar > 0
			BEGIN	
				SELECT @validar = COUNT(1) FROM Sucursal WHERE IdEmpresa = @IdEmpresa
				IF @validar > 0 
					BEGIN
						SET @Resultado = 'Error__la Empresa (' + @NombreEmpresa +') no se puede Eliminar, actualmente se encuentra en Uso'	
					END
				ELSE
					BEGIN
						DELETE Empresa WHERE Id = @IdEmpresa
						SET @Resultado = 'OK__Se Elimino la Empresa correctamente'	
					END								
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar la Empresa' 
			END
	SELECT @Resultado
END

go


CREATE TABLE Sucursal 
(Id int identity(1,1) Primary key ,
IdEmpresa int,
Nombre varchar(255),
Email varchar(255),
Telefono varchar(255),
Contacto varchar(255),
Direccion varchar(255),
IdCiudad int,
Activo int default 1,
IdUsuarioCrea int,
FechaCreacion datetime,
unique(Nombre)
)

ALTER TABLE Sucursal ADD CONSTRAINT FK_IdEmpresa FOREIGN KEY (IdEmpresa) references Empresa(Id)
ALTER TABLE Sucursal ADD CONSTRAINT FK_IdUsuarioCreaSucursal FOREIGN KEY (IdUsuarioCrea ) references Usuario(Id)
ALTER TABLE Sucursal ADD CONSTRAINT FK_IdCiudadCreaSucursal FOREIGN KEY (IdCiudad ) references Ciudad(Id)

go

CREATE PROCEDURE [dbo].[SP_GridSucursal]
AS
BEGIN
	SELECT	S.Id, 
			E.Id As IdEmpresa,
			E.Nombre As NombreEmpresa, 
			S.Nombre,
			S.Email,
			S.Telefono,
			S.Contacto, 
			S.Direccion As DireccionSucursal,
			S.IdCiudad,
			C.Nombre As NombreCiudad,
			S.Activo,
			CASE S.Activo
			WHEN 1 THEN 'Activo'
			ELSE 'Inactivo'
			END as Estado,
			dbo.Fun_BuscarNombreUsuario(S.IdUsuarioCrea) As NombreUsuario, 
			CONVERT(varchar,S.FechaCreacion,20) AS FechaCreacion
			FROM	Empresa E,
					Sucursal S,
					Ciudad C
			WHERE	S.IdEmpresa = E.Id AND
					S.IdCiudad = C.Id
END

go

CREATE PROCEDURE [dbo].[SP_ListaSucursal]
AS
BEGIN
	SELECT Id, Nombre FROM Sucursal WHERE Activo = 1
END

go

CREATE PROCEDURE [dbo].[SP_CrearSucursal] @IdUser varchar(255), @Modulo varchar(255), @IdEmpresa int, @NombreSucursal varchar(255), @EmailSucursal varchar(255), @TelefonoSucursal varchar(255), @ContactoSucursal varchar(255), @DireccionSucursal varchar(255), @IdCiudad int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Crear INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT	@Crear = dbo.Fun_PermisoUsuario('Crear',@IdUsuario, @Modulo)	
		IF @Crear > 0
			BEGIN
				INSERT INTO Sucursal(IdEmpresa,Nombre,Email,Telefono,Contacto,Direccion,IdCiudad,IdUsuarioCrea, FechaCreacion) 
				VALUES 
				(@IdEmpresa, @NombreSucursal, @EmailSucursal, @TelefonoSucursal, @ContactoSucursal, @DireccionSucursal, @IdCiudad, @IdUsuario, GETDATE()) 
				SET @Resultado = 'OK__Se a creado la Sucursal (' + @NombreSucursal+ ') correctamente'
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para crear Sucursal' 
			END
	SELECT @Resultado
END

go

CREATE PROCEDURE [dbo].[SP_GuardarCambiosSucursal] @IdUser varchar(255), @Modulo varchar(255), @IdEmpresa int, @IdSucursal int, @NombreSucursal varchar(255), @EmailSucursal varchar(255), @TelefonoSucursal varchar(255), @ContactoSucursal varchar(255), @DireccionSucursal varchar(255), @IdCiudad int, @Activo int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Modificar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @Modificar = dbo.Fun_PermisoUsuario('Modificar',@IdUsuario, @Modulo)	
				IF @Modificar > 0
					BEGIN
						UPDATE Sucursal SET IdEmpresa = @IdEmpresa, 
											Nombre = @NombreSucursal, 
											Email = @EmailSucursal,
											Telefono = @TelefonoSucursal,
											Contacto = @ContactoSucursal,
											Direccion = @DireccionSucursal,
											IdCiudad = @IdCiudad,
											Activo = @Activo 
						WHERE Id = @IdSucursal
					    SET @Resultado = 'OK__Se guardaron los cambios de la Sucursal (' + @NombreSucursal+ ') correctamente'
					END
				ELSE
					BEGIN
						SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para realizar cambios a la Sucursal' 
					END
	SELECT @Resultado
END
go

CREATE PROCEDURE [dbo].[SP_EliminarSucursal] @IdUser varchar(255), @Modulo varchar(255), @IdSucursal int, @Resultado varchar(255) OUTPUT
AS
BEGIN
DECLARE @Eliminar INT, @IdUsuario INT, @NombreUsuario VARCHAR(255), @validar INT, @NombreSucursal varchar(255)
SELECT @IdUsuario = Id FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreUsuario = Nombre FROM Usuario WHERE IdUser = @IdUser
SELECT @NombreSucursal = Nombre FROM Empresa WHERE Id = @IdSucursal
	SELECT	@Eliminar = dbo.Fun_PermisoUsuario('Eliminar',@IdUsuario, @Modulo)	
		IF @Eliminar > 0
			BEGIN
			SET @validar = 0
				--SELECT @validar = COUNT(1) FROM Sucursal WHERE IdEmpresa = @IdEmpresa
				IF @validar > 0 
					BEGIN
						SET @Resultado = 'Error__La Sucursal (' + @NombreSucursal +') no se puede Eliminar, actualmente se encuentra en Uso'	
					END
				ELSE
					BEGIN
						DELETE Sucursal WHERE Id = @IdSucursal
						SET @Resultado = 'OK__Se Elimino la Sucursal correctamente'	
					END								
			END
		ELSE
			BEGIN
				SET @Resultado = 'Error__El Usuario ('+ @NombreUsuario + ') no tiene permiso para Eliminar la Sucursal' 
			END
	SELECT @Resultado
END

go


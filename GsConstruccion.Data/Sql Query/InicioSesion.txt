CREATE PROCEDURE [dbo].[SP_IniciarSesion] @Usuario varchar(255), @Password varchar(255), 
@Resultado varchar(max) OUTPUT
AS
BEGIN
DECLARE @ExisteUser INT, @ValidaPassword varchar(255), @IdUser varchar(255),
	@PasswordMd5 varchar(255), @UsuarioMd5 varchar(255), @IdUsuario int, @Vigencia datetime,
	@NombreUser varchar(255), @FechaActual datetime, @Activo Int
	SELECT @UsuarioMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Usuario ), 2)
	SELECT @PasswordMd5 = CONVERT ( VARCHAR (32), HashBytes ( 'MD5' ,  @Password ), 2)
	SELECT @ExisteUser = COUNT(1) FROM Usuario Where IdUser = @UsuarioMd5
	SELECT @ValidaPassword = Password  FROM Usuario WHERE IdUser = @UsuarioMd5
	SELECT @IdUsuario = Id FROM Usuario Where IdUser = @UsuarioMd5
	SELECT @NombreUser = Usuario FROM Usuario WHERE IdUser =  @UsuarioMd5
	SELECT @Vigencia = FechaVigencia FROM Usuario WHERE IdUser = @UsuarioMd5
	SELECT @FechaActual = GETDATE()
	Select @Activo = Activo FROM Usuario WHERE Id = @IdUsuario
	
	IF @ExisteUser = 0
		BEGIN
			SET @Resultado = 'Error__El Usuario ingresado no Existe'
		END
	ELSE
		BEGIN		
		SELECT @IdUser = IdUser FROM Usuario where IdUser = @UsuarioMd5
			IF @ValidaPassword = @PasswordMd5
				BEGIN
					IF @FechaActual < @Vigencia  
						BEGIN
							IF @Activo = 1
								BEGIN
									--INSERT INTO Log_InicioSesion (IdUser,FechaIngreso)VALUES(@IdUsuario, GETDATE())
									SET @Resultado = 'OK__'+@IdUser
								END
							ELSE
								BEGIN
									SET @Resultado = 'Error__El Usuario se encuentra Inactivo, por favor comuniquese con el Administrador de la Aplicación'
								END
						END
					ELSE
						BEGIN
							SET @Resultado = 'Error__El Usuario '+@NombreUser+' no tiene permisos para ingresar a la Aplicación, la fecha limite de ingreso se encuentra vencida. Si desea Activar un nuevo periodo de tiempo comuniquese con el Administrador de la Aplicación.'
						END					
				END
			ELSE
				BEGIN
					SET @Resultado = 'Error__Contraseña incorrecta'
				END
		END
	SELECT @Resultado
END